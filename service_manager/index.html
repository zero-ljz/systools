<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="icon" href="data:,">

</head>

<body>
    <form method="get" onsubmit="this.action = BASE_URL + 'find_process';" id="form1">
        <input type="text" name="cmd_line" placeholder="Command Line or PID" value="">
        <input type="submit" value="Find Process">
    </form>
    <hr style="margin:10px 0; border:0;">

    <form method="get" onsubmit="this.action = BASE_URL + 'test_start';" id="form2">
        <input type="text" name="cmd" placeholder="Command" value="">
        <input type="text" name="cwd" placeholder="Current Working Directory" value="">
        <input type="submit" value="Test Start">
    </form>
    <hr style="margin:10px 0; border:0;">

    <form>
        <textarea name="sourceText" rows="2" placeholder="Source Text "></textarea><br/>
        <input type="text" name="keyword" placeholder="" size="1" title="Keyword: å¤šä¸ªç”¨,åˆ†éš”" value="\">
        <span>to:</span>
        <input type="text" name="replacement" placeholder="" size="1" title="Replacement" value="/">
        <button type="button" onclick="
        const form = this.parentElement;
        const keywords = form.elements['keyword'].value.split(',').map(k => k.trim()).filter(k => k);
        const replacement = form.elements['replacement'].value;
        const sourceTextInput = form.elements['sourceText'];
    
        let result = sourceTextInput.value;
        for (const key of keywords) {
          const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          result = result.replace(regex, replacement);
        }
        sourceTextInput.value= result;
      ">Replace</button>
    </form>

    <hr style="margin:10px 0; border:0;">

    <h2>
        Service List
    </h2>
    <section style="overflow: auto; white-space: nowrap;">
        <button value="Add">Add</button>
        <button value="Start">Start</button>
        <button value="Stop">Stop</button>
        <hr style="margin:3px 0; border:0;">
        <table id="serviceTable">
        </table>

    </section>

        <script>
            
function createTaskTable(services) {
let table = document.createElement('table');
table.className = 'table table-striped';
table.setAttribute('border', '1');
table.setAttribute('cellspacing', '0');
table.style.width = '100%';
table.innerHTML = `
<thead>
                <tr style="background-color: lightgray; text-align: left;">
                    <th style="padding: 5px;"><input type="checkbox" onclick="document.querySelectorAll(\`table > tbody tr td input[type='checkbox']\`).forEach(checkbox => checkbox.checked = this.checked);"></th>
                    <th style="padding: 5px;">Name</th>
                    <th style="padding: 5px;">Command</th>
                    <th style="padding: 5px;">Working Directory</th>
                    <th style="padding: 5px;">Is Enable</th>
                    <th style="padding: 5px;">Process Status</th>
                    <th style="padding: 5px;">Actions</th>
                    <th style="padding: 5px;">Run Log</th>
                </tr>
            </thead>
            <tbody>
`;
let tbody = table.querySelector('tbody');
Object.entries(services).forEach(([name, service]) => {
const row = document.createElement('tr');
row.innerHTML = `
    <td style="padding: 5px;"><input type="checkbox" value="${name}"></td>
    <td style="padding: 5px;"><a onclick="location.href='${BASE_URL}update?name=${name}.json'; return false;" href="#">${name}</a></td>
    <td><textarea name="cmd" cols="40" rows="3" style="border: none; outline: none;" readonly>${service.cmd}</textarea></td>
    <td style="padding: 5px;">${service.cwd}</td>
    <td style="padding: 5px;">${service.enabled? 'ðŸŸ¢' : 'âšª'}</td>
    <td style="padding: 5px;">${service.status}</td>
<td style="padding: 5px;">
                        <button onclick = "this.disabled = true;
                        (() => {
                            fetch('${BASE_URL}${service.status.startsWith('running') ? 'stop' : 'start'}?name=' + encodeURIComponent('${name}'))
                            .then(async (resp) => { text = await resp.text(); alert(text); this.disabled = false; location.reload(); }); 
                        })();
                        void(0);">${service.status.startsWith('running') ? 'Stop' : 'Start'}</button>

                        <button onclick="if (!confirm('ä½ ç¡®å®šå—ï¼Ÿ')) return; this.disabled = true;
                        (() => { 
                            fetch('${BASE_URL}delete?name=' + encodeURIComponent('${name}' + '.json'))
                            .then(async (resp) => { text = await resp.text(); alert(text); this.disabled = false; location.reload(); }); 
                        })();" style="color: red;">Delete</button>
                    </td>
                    <td style="padding: 5px;">
                        <a href="javascript:location.href='${BASE_URL}log_view?name=${name}.json';">View</a>
                        <button onclick="if (!confirm('ä½ ç¡®å®šå—ï¼Ÿ')) return; this.disabled = true;
                        (() => { 
                            fetch('${BASE_URL}clear_log?name=' + encodeURIComponent('${name}.json'))
                            .then(async (resp) => { text = await resp.text(); alert(text); this.disabled = false; location.reload(); }); 
                        })();" style="color: orange;">Clear</button>
                    </td>
    `;
tbody.appendChild(row);
});
return table;
}
fetch(`/service_manager/services`)
.then(response => response.json())
.then(data => {
    
document.querySelector('table').replaceWith(createTaskTable(data));
return data;
})
.catch(error => {
console.error('èŽ·å–æœåŠ¡åˆ—è¡¨æ—¶å‡ºé”™', error);
});


            document.querySelector('button[value="Add"]').addEventListener('click', () => { const q = prompt('è¯·è¾“å…¥æœåŠ¡åç§°ï¼š', ''); if (q == null || q.trim() === '') return; location.href = BASE_URL + 'update?name=' + q + '.json'; })

            document.querySelector('button[value="Start"]').addEventListener('click', () => {
                const names = []; 
                document.querySelectorAll(`table > tbody tr td input[type='checkbox']:checked`).forEach(checkbox => names.push(checkbox.value)); 
                if (names.length == 0) { alert('ä½ è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•ä¸€é¡¹'); return; }
                if (!confirm('å·²é€‰æ‹© ' + names.length + ' é¡¹ï¼Œ' + 'ä½ ç¡®å®šå—ï¼Ÿ')) return; this.disabled = true;
                (() => {
                fetch(BASE_URL + 'start?name=' + encodeURIComponent(names.join(',')))
                .then(async (resp) => { text = await resp.text(); alert(text); this.disabled = false; location.reload(); })
                })();
                void(0);
            });

            document.querySelector('button[value="Stop"]').addEventListener('click', () => {
                const names = []; 
                document.querySelectorAll(`table > tbody tr td input[type='checkbox']:checked`).forEach(checkbox => names.push(checkbox.value)); 
                if (names.length == 0) { alert('ä½ è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•ä¸€é¡¹'); return; }
                if (!confirm('å·²é€‰æ‹© ' + names.length + ' é¡¹ï¼Œ' + 'ä½ ç¡®å®šå—ï¼Ÿ')) return; this.disabled = true;
                (() => {
                fetch(BASE_URL + 'stop?name=' + encodeURIComponent(names.join(',')))
                .then(async (resp) => { text = await resp.text(); alert(text); this.disabled = false; location.reload(); })
                })();
                void(0);
            });
        
        




  function getBaseUrl() {
    let { protocol, host, pathname } = window.location;
    // pathname æœªä»¥/ç»“å°¾æ—¶åŠ ä¸Š/
    if (!pathname.endsWith('/')) {
      pathname += '/';
    }
    const path = pathname.substring(0, pathname.lastIndexOf('/') + 1);
    return `${protocol}//${host}${path}`;
  }
  const BASE_URL = getBaseUrl();
  console.log("BASE_URL:", BASE_URL);
    </script>
</body>

</html>