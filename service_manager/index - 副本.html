<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœåŠ¡ç®¡ç†å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="icon" href="data:,">
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title">æœåŠ¡ç®¡ç†å™¨</h1>

      <!-- æŸ¥æ‰¾è¿›ç¨‹ -->
      <form method="get" onsubmit="this.action = BASE_URL + 'find_process';" id="form1" class="box">
        <div class="field is-grouped">
          <div class="control is-expanded">
            <input class="input" type="text" name="cmd_line" placeholder="Command Line or PID">
          </div>
          <div class="control">
            <input class="button is-link" type="submit" value="Find Process">
          </div>
        </div>
      </form>

      <!-- æµ‹è¯•å¯åŠ¨ -->
      <form method="get" onsubmit="this.action = BASE_URL + 'test_start';" id="form2" class="box">
        <div class="field">
          <label class="label">Command</label>
          <div class="control">
            <input class="input" type="text" name="cmd" placeholder="Command">
          </div>
        </div>
        <div class="field">
          <label class="label">Working Directory</label>
          <div class="control">
            <input class="input" type="text" name="cwd" placeholder="Current Working Directory">
          </div>
        </div>
        <div class="field">
          <div class="control">
            <input class="button is-info" type="submit" value="Test Start">
          </div>
        </div>
      </form>

      <!-- æ›¿æ¢æ–‡æœ¬ -->
      <form class="box">
        <div class="field">
          <label class="label">Source Text</label>
          <div class="control">
            <textarea class="textarea" name="sourceText" rows="2" placeholder="Source Text"></textarea>
          </div>
        </div>
        <div class="field is-grouped">
          <div class="control">
            <input class="input" type="text" name="keyword" placeholder="å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" value="\">
          </div>
          <div class="control">
            <input class="input" type="text" name="replacement" placeholder="æ›¿æ¢ä¸º" value="/">
          </div>
          <div class="control">
            <button class="button is-warning" type="button" onclick="
              const form = this.closest('form');
              const keywords = form.elements['keyword'].value.split(',').map(k => k.trim()).filter(k => k);
              const replacement = form.elements['replacement'].value;
              const sourceTextInput = form.elements['sourceText'];
              let result = sourceTextInput.value;
              for (const key of keywords) {
                const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                result = result.replace(regex, replacement);
              }
              sourceTextInput.value = result;
            ">Replace</button>
          </div>
        </div>
      </form>

      <!-- æœåŠ¡åˆ—è¡¨ -->
      <section class="section">
        <h2 class="title is-4">æœåŠ¡åˆ—è¡¨</h2>
        <div class="buttons">
          <button class="button is-primary" value="Add">Add</button>
          <button class="button is-success" value="Start">Start</button>
          <button class="button is-danger" value="Stop">Stop</button>
        </div>
        <div class="table-container">
          <table class="table is-striped is-fullwidth" id="serviceTable"></table>
        </div>
      </section>
    </div>
  </section>

  <script>
    function createTaskTable(services) {
      let table = document.createElement('table');
      table.className = 'table is-striped is-fullwidth';
      table.innerHTML = `
        <thead>
          <tr>
            <th><input type="checkbox" onclick="document.querySelectorAll('table > tbody tr td input[type=checkbox]').forEach(cb => cb.checked = this.checked);"></th>
            <th>Name</th>
            <th>Command</th>
            <th>Working Directory</th>
            <th>Is Enable</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Log</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      let tbody = table.querySelector('tbody');
      Object.entries(services).forEach(([name, service]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" value="${name}"></td>
          <td><a href="#" onclick="location.href='${BASE_URL}update?name=${name}.json'; return false;">${name}</a></td>
          <td><textarea readonly class="textarea is-small">${service.cmd}</textarea></td>
          <td>${service.cwd}</td>
          <td>${service.enabled ? 'ğŸŸ¢' : 'âšª'}</td>
          <td>${service.status}</td>
          <td>
            <button class="button is-small ${service.status.startsWith('running') ? 'is-danger' : 'is-success'}" onclick="
              this.disabled = true;
              (() => {
                fetch('${BASE_URL}${service.status.startsWith('running') ? 'stop' : 'start'}?name=' + encodeURIComponent('${name}'))
                .then(async resp => { alert(await resp.text()); this.disabled = false; location.reload(); });
              })();">${service.status.startsWith('running') ? 'Stop' : 'Start'}</button>
            <button class="button is-small is-danger" onclick="
              if (!confirm('ä½ ç¡®å®šå—ï¼Ÿ')) return;
              this.disabled = true;
              (() => {
                fetch('${BASE_URL}delete?name=' + encodeURIComponent('${name}.json'))
                .then(async resp => { alert(await resp.text()); this.disabled = false; location.reload(); });
              })();">Delete</button>
          </td>
          <td>
            <a class="button is-small is-link" href="${BASE_URL}log_view?name=${name}.json">View</a>
            <button class="button is-small is-warning" onclick="
              if (!confirm('ä½ ç¡®å®šå—ï¼Ÿ')) return;
              this.disabled = true;
              (() => {
                fetch('${BASE_URL}clear_log?name=' + encodeURIComponent('${name}.json'))
                .then(async resp => { alert(await resp.text()); this.disabled = false; location.reload(); });
              })();">Clear</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      return table;
    }

    function getBaseUrl() {
      let { protocol, host, pathname } = window.location;
      if (!pathname.endsWith('/')) pathname += '/';
      const path = pathname.substring(0, pathname.lastIndexOf('/') + 1);
      return `${protocol}//${host}${path}`;
    }

    const BASE_URL = getBaseUrl();
    console.log("BASE_URL:", BASE_URL);

    fetch(`/service_manager/services`)
      .then(response => response.json())
      .then(data => {
        document.querySelector('#serviceTable').replaceWith(createTaskTable(data));
      })
      .catch(error => console.error('è·å–æœåŠ¡åˆ—è¡¨æ—¶å‡ºé”™', error));

    document.querySelector('button[value="Add"]').addEventListener('click', () => {
      const q = prompt('è¯·è¾“å…¥æœåŠ¡åç§°ï¼š', '');
      if (!q || q.trim() === '') return;
      location.href = BASE_URL + 'update?name=' + q + '.json';
    });

    document.querySelector('button[value="Start"]').addEventListener('click', () => {
      const names = Array.from(document.querySelectorAll('table tbody input[type=checkbox]:checked')).map(cb => cb.value);
      if (names.length === 0) return alert('ä½ è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•ä¸€é¡¹');
      if (!confirm(`å·²é€‰æ‹© ${names.length} é¡¹ï¼Œç¡®å®šå¯åŠ¨ï¼Ÿ`)) return;
      fetch(BASE_URL + 'start?name=' + encodeURIComponent(names.join(',')))
        .then(async resp => { alert(await resp.text()); location.reload(); });
    });

    document.querySelector('button[value="Stop"]').addEventListener('click', () => {
      const names = Array.from(document.querySelectorAll('table tbody input[type=checkbox]:checked')).map(cb => cb.value);
      if (names.length === 0) return alert('ä½ è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•ä¸€é¡¹');
      if (!confirm(`å·²é€‰æ‹© ${names.length} é¡¹ï¼Œç¡®å®šåœæ­¢ï¼Ÿ`)) return;
      fetch(BASE_URL + 'stop?name=' + encodeURIComponent(names.join(',')))
        .then(async resp => { alert(await resp.text()); location.reload(); });
    });
  </script>
</body>
</html>
